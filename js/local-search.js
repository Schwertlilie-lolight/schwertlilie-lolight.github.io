window.addEventListener("DOMContentLoaded",()=>{let e,t=!1,o=!0,n=CONFIG.path;0===n.length?n="search.xml":/json$/i.test(n)&&(o=!1);const r=CONFIG.root+n,l=document.getElementById("search-input"),s=document.getElementById("search-result"),a=(e,t,o)=>{let n=e.length;if(0===n)return[];let r=0,l=[],s=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(l=t.indexOf(e,r))>-1;)s.push({position:l,word:e}),r=l+n;return s},i=(e,t,o,n,r)=>{let l=n[n.length-1],s=l.position,a=l.word,i=[],c=0;for(;s+a.length<=o&&0!==n.length;){a===r&&c++,i.push({position:s,length:a.length});let e=s+a.length;for(n.pop();0!==n.length&&(s=(l=n[n.length-1]).position,a=l.word,e>s);)n.pop()}return{hits:i,start:t,end:o,searchTextCount:c}},c=(e,t)=>{let o="",n=t.start;return t.hits.forEach(t=>{o+=e.substring(n,t.position);let r=t.position+t.length;o+=`<b class="search-keyword">${e.substring(t.position,r)}</b>`,n=r}),o+=e.substring(n,t.end)},h=()=>{let t=l.value.trim().toLowerCase(),o=t.split(/[-\s]+/);o.length>1&&o.push(t);let n=[];if(t.length>0&&e.forEach(e=>{if(!e.title)return;let r=0,l=e.title.trim(),s=l.toLowerCase(),h=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";CONFIG.localsearch.unescape&&(h=(e=>String(e).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#x3A;/g,":").replace(/&#(\d+);/g,(e,t)=>String.fromCharCode(t)).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"))(h));let u=h.toLowerCase(),p=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(o.forEach(e=>{d=d.concat(a(e,s,!1)),g=g.concat(a(e,u,!1))}),d.length>0||g.length>0){let e=d.length+g.length;[d,g].forEach(e=>{e.sort((e,t)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length)});let o=[];if(0!==d.length){let e=i(0,0,l.length,d,t);r+=e.searchTextCountInSlice,o.push(e)}let s=[];for(;0!==g.length;){let e=g[g.length-1],o=e.position,n=e.word,l=o-20,a=o+80;l<0&&(l=0),a<o+n.length&&(a=o+n.length),a>h.length&&(a=h.length);let c=i(0,l,a,g,t);r+=c.searchTextCountInSlice,s.push(c)}s.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);let a=parseInt(CONFIG.localsearch.top_n_per_article,10);a>=0&&(s=s.slice(0,a));let u="";0!==o.length?u+=`<li><a href="${p}" class="search-result-title">${c(l,o[0])}</a>`:u+=`<li><a href="${p}" class="search-result-title">${l}</a>`,s.forEach(e=>{u+=`<a href="${p}"><p class="search-result">${c(h,e)}...</p></a>`}),u+="</li>",n.push({item:u,searchTextCount:r,hitCount:e,id:n.length})}}),1===o.length&&""===o[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===n.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{n.sort((e,t)=>e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id);let e='<ul class="search-result-list">';n.forEach(t=>{e+=t.item}),e+="</ul>",s.innerHTML=e,window.pjax&&window.pjax.refresh(s)}},u=n=>{fetch(r).then(e=>e.text()).then(r=>{t=!0,e=o?$("entry",r).map((e,t)=>({title:$("title",t).text(),content:$("content",t).text(),url:$("url",t).text()})).get():JSON.parse(r),document.querySelector(".search-pop-overlay").innerHTML="",document.body.style.overflow="",n&&n()})};CONFIG.localsearch.preload&&u();const p=()=>{document.body.style.overflow="hidden",document.querySelector(".search-pop-overlay").style.display="block",document.querySelector(".popup").style.display="block",document.getElementById("search-input").focus()};"auto"===CONFIG.localsearch.trigger?l.addEventListener("input",h):(document.querySelector(".search-icon").addEventListener("click",h),l.addEventListener("keypress",e=>{13===e.keyCode&&h()})),document.querySelector(".popup-trigger").addEventListener("click",e=>{e.stopPropagation(),!1===t?(document.querySelector(".search-pop-overlay").style.display="",document.querySelector(".search-pop-overlay").innerHTML='<div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div>',document.querySelector("#search-loading-icon").css({margin:"20% auto 0 auto","text-align":"center"}),u(p)):p()});const d=()=>{document.body.style.overflow="",document.querySelector(".search-pop-overlay").style.display="none",document.querySelector(".popup").style.display="none"};document.querySelector(".search-pop-overlay").addEventListener("click",d),document.querySelector(".popup-btn-close").addEventListener("click",d),window.addEventListener("pjax:success",d),window.addEventListener("keyup",e=>{27===e.which&&document.querySelector(".popup").isVisible()&&d()})});